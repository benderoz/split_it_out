<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–∫–∏ 405</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        #fileInput { margin: 10px 0; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–∫–∏ HTTP 405</h1>
    
    <div class="test">
        <h3>1. –¢–µ—Å—Ç –∑–¥–æ—Ä–æ–≤—å—è API</h3>
        <button onclick="testHealth()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å /api/health</button>
        <div id="healthResult"></div>
    </div>
    
    <div class="test">
        <h3>2. –¢–µ—Å—Ç POST –±–µ–∑ —Ñ–∞–π–ª–∞</h3>
        <button onclick="testEmptyPost()">–ü—É—Å—Ç–æ–π POST –Ω–∞ /api/upload-receipt</button>
        <div id="emptyPostResult"></div>
    </div>
    
    <div class="test">
        <h3>3. –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞</h3>
        <input type="file" id="fileInput" accept="image/*">
        <br>
        <button onclick="testFileUpload()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
        <div id="fileUploadResult"></div>
    </div>
    
    <div class="test">
        <h3>4. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–∞—É–∑–µ—Ä–µ</h3>
        <div id="browserInfo"></div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function showResult(containerId, message, isSuccess = true) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `result ${isSuccess ? 'success' : 'error'}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            container.appendChild(div);
            console.log(`[${containerId}]`, message);
        }

        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ fetch –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            console.log('üåê Fetch –∑–∞–ø—Ä–æ—Å:', args[0], args[1]);
            return originalFetch.apply(this, args)
                .then(response => {
                    console.log('üì• Fetch –æ—Ç–≤–µ—Ç:', response.status, response.statusText, response.url);
                    return response;
                })
                .catch(error => {
                    console.error('‚ùå Fetch –æ—à–∏–±–∫–∞:', error);
                    throw error;
                });
        };

        // –¢–µ—Å—Ç 1: Health check
        async function testHealth() {
            try {
                const response = await fetch('/api/health');
                if (response.ok) {
                    const data = await response.json();
                    showResult('healthResult', `‚úÖ SUCCESS: ${response.status} - ${JSON.stringify(data)}`, true);
                } else {
                    const text = await response.text();
                    showResult('healthResult', `‚ùå ERROR: ${response.status} ${response.statusText} - ${text}`, false);
                }
            } catch (error) {
                showResult('healthResult', `‚ùå EXCEPTION: ${error.message}`, false);
            }
        }

        // –¢–µ—Å—Ç 2: –ü—É—Å—Ç–æ–π POST
        async function testEmptyPost() {
            try {
                const response = await fetch('/api/upload-receipt', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showResult('emptyPostResult', `‚úÖ SUCCESS: ${response.status} - ${JSON.stringify(data)}`, true);
                } else {
                    const text = await response.text();
                    showResult('emptyPostResult', `‚ùå ERROR: ${response.status} ${response.statusText} - ${text.substring(0, 200)}`, false);
                }
            } catch (error) {
                showResult('emptyPostResult', `‚ùå EXCEPTION: ${error.message}`, false);
            }
        }

        // –¢–µ—Å—Ç 3: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
        async function testFileUpload() {
            const fileInput = document.getElementById('fileInput');
            
            if (!fileInput.files[0]) {
                showResult('fileUploadResult', '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!', false);
                return;
            }

            try {
                const formData = new FormData();
                formData.append('receipt', fileInput.files[0]);

                showResult('fileUploadResult', `üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª: ${fileInput.files[0].name} (${fileInput.files[0].size} bytes)`, true);

                const response = await fetch('/api/upload-receipt', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult('fileUploadResult', `‚úÖ SUCCESS: ${response.status} - ${JSON.stringify(data)}`, true);
                } else {
                    const text = await response.text();
                    showResult('fileUploadResult', `‚ùå ERROR: ${response.status} ${response.statusText} - ${text.substring(0, 300)}`, false);
                }
            } catch (error) {
                showResult('fileUploadResult', `‚ùå EXCEPTION: ${error.message}`, false);
            }
        }

        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–∞—É–∑–µ—Ä–µ
        function showBrowserInfo() {
            const info = {
                'User Agent': navigator.userAgent,
                'URL': window.location.href,
                'Origin': window.location.origin,
                'Protocol': window.location.protocol,
                'Host': window.location.host,
                'Port': window.location.port || 'default',
                'Telegram': !!window.Telegram,
                'Telegram WebApp': !!window.Telegram?.WebApp
            };

            let html = '<pre>';
            for (const [key, value] of Object.entries(info)) {
                html += `${key}: ${value}\n`;
            }
            html += '</pre>';

            document.getElementById('browserInfo').innerHTML = html;
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            showBrowserInfo();
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ç–µ—Å—Ç–∏—Ä—É–µ–º health
            setTimeout(testHealth, 1000);
        });

        // –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –æ—à–∏–±–∫–∏
        window.addEventListener('error', (e) => {
            console.error('üö® –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞:', e.error);
        });
    </script>
</body>
</html>