<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .result { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .error { background: #ffe6e6; }
        .success { background: #e6ffe6; }
        button { padding: 10px 20px; margin: 10px; }
    </style>
</head>
<body>
    <h1>üß™ –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞</h1>
    
    <div>
        <h3>1. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª:</h3>
        <input type="file" id="fileInput" accept="image/*">
    </div>
    
    <div>
        <h3>2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:</h3>
        <button onclick="testUploadAbsolute()">–¢–µ—Å—Ç —Å –∞–±—Å–æ–ª—é—Ç–Ω—ã–º URL</button>
        <button onclick="testUploadRelative()">–¢–µ—Å—Ç —Å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–º URL</button>
        <button onclick="testUploadWithHeaders()">–¢–µ—Å—Ç —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏</button>
    </div>
    
    <div>
        <h3>3. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</h3>
        <div id="results"></div>
    </div>

    <script>
        function addResult(message, isError = false) {
            const div = document.createElement('div');
            div.className = `result ${isError ? 'error' : 'success'}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('results').appendChild(div);
            console.log(message);
        }

        async function testUploadAbsolute() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files[0]) {
                addResult('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!', true);
                return;
            }

            try {
                addResult('–¢–µ—Å—Ç–∏—Ä—É–µ–º —Å –∞–±—Å–æ–ª—é—Ç–Ω—ã–º URL: http://localhost:3000/api/upload-receipt');
                
                const formData = new FormData();
                formData.append('receipt', fileInput.files[0]);

                const response = await fetch('http://localhost:3000/api/upload-receipt', {
                    method: 'POST',
                    body: formData
                });

                addResult(`–û—Ç–≤–µ—Ç: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const result = await response.text();
                    addResult(`–î–∞–Ω–Ω—ã–µ: ${result}`);
                } else {
                    const errorText = await response.text();
                    addResult(`–û—à–∏–±–∫–∞: ${errorText}`, true);
                }
            } catch (error) {
                addResult(`–ò—Å–∫–ª—é—á–µ–Ω–∏–µ: ${error.message}`, true);
            }
        }

        async function testUploadRelative() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files[0]) {
                addResult('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!', true);
                return;
            }

            try {
                addResult('–¢–µ—Å—Ç–∏—Ä—É–µ–º —Å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–º URL: /api/upload-receipt');
                
                const formData = new FormData();
                formData.append('receipt', fileInput.files[0]);

                const response = await fetch('/api/upload-receipt', {
                    method: 'POST',
                    body: formData
                });

                addResult(`–û—Ç–≤–µ—Ç: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const result = await response.text();
                    addResult(`–î–∞–Ω–Ω—ã–µ: ${result}`);
                } else {
                    const errorText = await response.text();
                    addResult(`–û—à–∏–±–∫–∞: ${errorText}`, true);
                }
            } catch (error) {
                addResult(`–ò—Å–∫–ª—é—á–µ–Ω–∏–µ: ${error.message}`, true);
            }
        }

        async function testUploadWithHeaders() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files[0]) {
                addResult('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!', true);
                return;
            }

            try {
                addResult('–¢–µ—Å—Ç–∏—Ä—É–µ–º —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏');
                
                const formData = new FormData();
                formData.append('receipt', fileInput.files[0]);

                const response = await fetch('/api/upload-receipt', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        // –ù–ï —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Content-Type –¥–ª—è FormData
                    },
                    body: formData
                });

                addResult(`–û—Ç–≤–µ—Ç: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const result = await response.text();
                    addResult(`–î–∞–Ω–Ω—ã–µ: ${result}`);
                } else {
                    const errorText = await response.text();
                    addResult(`–û—à–∏–±–∫–∞: ${errorText}`, true);
                }
            } catch (error) {
                addResult(`–ò—Å–∫–ª—é—á–µ–Ω–∏–µ: ${error.message}`, true);
            }
        }

        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö fetch –∑–∞–ø—Ä–æ—Å–æ–≤
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            console.log('Fetch –∑–∞–ø—Ä–æ—Å:', args);
            return originalFetch.apply(this, args)
                .then(response => {
                    console.log('Fetch –æ—Ç–≤–µ—Ç:', response.status, response.statusText);
                    return response;
                })
                .catch(error => {
                    console.log('Fetch –æ—à–∏–±–∫–∞:', error);
                    throw error;
                });
        };
    </script>
</body>
</html>