<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 10px; 
            font-size: 14px;
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
        }
        .section { 
            margin: 15px 0; 
            padding: 15px; 
            border: 1px solid #ccc; 
            border-radius: 8px;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
        }
        .ok { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        button { 
            padding: 8px 15px; 
            margin: 5px; 
            border: none;
            border-radius: 5px;
            background: var(--tg-theme-button-color, #007bff);
            color: var(--tg-theme-button-text-color, #fff);
            cursor: pointer;
        }
        .log { 
            background: #000; 
            color: #0f0; 
            padding: 10px; 
            font-family: monospace; 
            font-size: 12px;
            max-height: 200px; 
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>üîç Debug Telegram Mini App</h1>
    
    <div class="section">
        <h2>1. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ Telegram WebApp</h2>
        <div id="telegram-info"></div>
    </div>
    
    <div class="section">
        <h2>2. –¢–µ—Å—Ç API —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</h2>
        <button onclick="testAPI()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å API</button>
        <div id="api-result"></div>
    </div>
    
    <div class="section">
        <h2>3. –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤</h2>
        <input type="file" id="testFile" accept="image/*">
        <button onclick="testUpload()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª</button>
        <div id="upload-result"></div>
    </div>
    
    <div class="section">
        <h2>4. –õ–æ–≥ –æ—à–∏–±–æ–∫</h2>
        <button onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
        <div id="error-log" class="log"></div>
    </div>

    <script>
        let logDiv = document.getElementById('error-log');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(logEntry);
        }
        
        function clearLog() {
            logDiv.textContent = '';
        }
        
        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏
        window.addEventListener('error', (e) => {
            log(`JS Error: ${e.message} at ${e.filename}:${e.lineno}`, 'error');
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            log(`Unhandled Promise Rejection: ${e.reason}`, 'error');
        });
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º Telegram WebApp
        function checkTelegramWebApp() {
            const infoDiv = document.getElementById('telegram-info');
            let html = '';
            
            try {
                if (window.Telegram && window.Telegram.WebApp) {
                    const tg = window.Telegram.WebApp;
                    
                    html += `<div class="ok">‚úÖ Telegram WebApp –Ω–∞–π–¥–µ–Ω</div>`;
                    html += `<div><strong>–í–µ—Ä—Å–∏—è:</strong> ${tg.version || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞'}</div>`;
                    html += `<div><strong>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:</strong> ${tg.platform || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞'}</div>`;
                    html += `<div><strong>–¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞:</strong> ${tg.colorScheme || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞'}</div>`;
                    html += `<div><strong>–í—ã—Å–æ—Ç–∞ viewport:</strong> ${tg.viewportHeight || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞'}</div>`;
                    html += `<div><strong>–í—ã—Å–æ—Ç–∞ viewport (—Å—Ç–∞–±–∏–ª—å–Ω–∞—è):</strong> ${tg.viewportStableHeight || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞'}</div>`;
                    
                    if (tg.initData) {
                        html += `<div class="ok"><strong>InitData:</strong> –ø–æ–ª—É—á–µ–Ω—ã (${tg.initData.length} —Å–∏–º–≤–æ–ª–æ–≤)</div>`;
                    } else {
                        html += `<div class="warning"><strong>InitData:</strong> –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</div>`;
                    }
                    
                    if (tg.initDataUnsafe && Object.keys(tg.initDataUnsafe).length > 0) {
                        html += `<div><strong>InitDataUnsafe:</strong> ${JSON.stringify(tg.initDataUnsafe, null, 2)}</div>`;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç–æ–¥—ã
                    const methods = ['ready', 'expand', 'close', 'sendData', 'showAlert', 'showPopup'];
                    const availableMethods = methods.filter(method => typeof tg[method] === 'function');
                    html += `<div><strong>–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç–æ–¥—ã:</strong> ${availableMethods.join(', ')}</div>`;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–Ω–æ–ø–∫–∏
                    if (tg.MainButton) {
                        html += `<div><strong>MainButton:</strong> –¥–æ—Å—Ç—É–ø–Ω–∞</div>`;
                    }
                    if (tg.BackButton) {
                        html += `<div><strong>BackButton:</strong> –¥–æ—Å—Ç—É–ø–Ω–∞</div>`;
                    }
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º
                    try {
                        tg.ready();
                        tg.expand();
                        html += `<div class="ok">‚úÖ WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω</div>`;
                    } catch (initError) {
                        html += `<div class="error">‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${initError.message}</div>`;
                        log(`Telegram WebApp init error: ${initError.message}`, 'error');
                    }
                    
                } else {
                    html += `<div class="warning">‚ö†Ô∏è Telegram WebApp –Ω–µ –Ω–∞–π–¥–µ–Ω</div>`;
                    html += `<div>window.Telegram: ${typeof window.Telegram}</div>`;
                    html += `<div>User Agent: ${navigator.userAgent}</div>`;
                }
                
            } catch (error) {
                html += `<div class="error">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ${error.message}</div>`;
                log(`Telegram check error: ${error.message}`, 'error');
            }
            
            infoDiv.innerHTML = html;
        }
        
        async function testAPI() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.innerHTML = '–¢–µ—Å—Ç–∏—Ä—É–µ–º...';
            
            try {
                log('–ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç API');
                
                // –¢–µ—Å—Ç health check
                const healthResponse = await fetch('/api/health');
                log(`Health check status: ${healthResponse.status}`);
                
                if (healthResponse.ok) {
                    const healthData = await healthResponse.json();
                    log(`Health check OK: ${JSON.stringify(healthData)}`);
                    resultDiv.innerHTML = '<div class="ok">‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç</div>';
                } else {
                    throw new Error(`Health check failed: ${healthResponse.status}`);
                }
                
            } catch (error) {
                log(`API test error: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞ API: ${error.message}</div>`;
            }
        }
        
        async function testUpload() {
            const resultDiv = document.getElementById('upload-result');
            const fileInput = document.getElementById('testFile');
            
            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<div class="warning">‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</div>';
                return;
            }
            
            try {
                log('–ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
                resultDiv.innerHTML = '–ó–∞–≥—Ä—É–∂–∞–µ–º...';
                
                const formData = new FormData();
                formData.append('receipt', fileInput.files[0]);
                
                const response = await fetch('/api/upload-receipt', {
                    method: 'POST',
                    body: formData
                });
                
                log(`Upload response status: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.json();
                    log(`Upload OK: ${JSON.stringify(result)}`);
                    resultDiv.innerHTML = '<div class="ok">‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç</div>';
                } else {
                    const errorText = await response.text();
                    throw new Error(`Upload failed: ${response.status} - ${errorText}`);
                }
                
            } catch (error) {
                log(`Upload test error: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            log('Debug —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            checkTelegramWebApp();
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç API —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
            setTimeout(testAPI, 1000);
        });
    </script>
</body>
</html>