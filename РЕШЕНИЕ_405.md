# ✅ Решение ошибки HTTP 405

## Что было исправлено

### 1. Улучшена CORS конфигурация в `server.js`
- Добавлена детальная настройка CORS с поддержкой всех необходимых методов
- Добавлена обработка preflight OPTIONS запросов
- Установлены правильные заголовки для межсайтовых запросов

### 2. Исправлены URL в `script.js`
- Заменены относительные URL на абсолютные
- Добавлены правильные заголовки для fetch запросов
- Улучшена совместимость с разными окружениями

### 3. Добавлено детальное логирование
- Все HTTP запросы теперь подробно логируются
- Легко отследить что именно происходит при загрузке файла

## Что должно работать сейчас

1. **Сервер перезапущен** с новыми настройками
2. **CORS корректно настроен** для всех типов запросов
3. **OPTIONS запросы обрабатываются** правильно
4. **URL-ы стали абсолютными** и более надежными

## Как проверить исправление

### 1. Основное приложение
```
http://localhost:3000
```
- Загрузите любое изображение чека
- Проблема с ошибкой 405 должна быть решена

### 2. Тестовая страница для диагностики
```
http://localhost:3000/test-simple.html
```
- Используйте для дополнительной диагностики если проблемы остались

### 3. Проверьте логи сервера
В терминале должны появляться детальные логи каждого запроса:
```
=== 2024-07-04T13:XX:XX.XXXZ ===
POST /api/upload-receipt from ::1
Headers: { ... }
================================
```

## Если проблема все еще есть

### Проверьте Developer Tools (F12)
1. Откройте **Network** tab
2. Загрузите файл
3. Посмотрите какие запросы отправляются
4. Проверьте их статус и ответы

### Возможные дополнительные проблемы

1. **Кэш браузера**: Ctrl+F5 для полной перезагрузки
2. **Прокси/nginx**: Если используется внешний веб-сервер
3. **Файрвол**: Может блокировать определенные типы запросов
4. **Antivirus**: Может блокировать POST запросы с файлами

### Если ничего не помогает

Попробуйте использовать тестовую страницу `test-simple.html` - она покажет более детальную информацию о том, какие именно запросы не работают.

## Технические детали

### Изменения в server.js
```javascript
// Улучшенная CORS конфигурация
app.use(cors({
  origin: true,
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization', 'Accept', 'X-Requested-With'],
  preflightContinue: false,
  optionsSuccessStatus: 204
}));

// Обработка OPTIONS запросов (preflight)
app.options('*', (req, res) => {
  // ... заголовки CORS
  res.sendStatus(204);
});
```

### Изменения в script.js
```javascript
// Абсолютные URL вместо относительных
const baseUrl = window.location.origin;
const uploadUrl = `${baseUrl}/api/upload-receipt`;

const response = await fetch(uploadUrl, {
    method: 'POST',
    body: formData,
    headers: {
        'Accept': 'application/json'
    }
});
```

Эти изменения должны полностью решить проблему с ошибкой HTTP 405.